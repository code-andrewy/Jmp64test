<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Error...</title>
    <style>
        :root {
            --accent: #00f2ff;
            --bg: #050505;
            --panel: rgba(20, 20, 20, 0.8);
        }

        body, html {
            margin: 0; padding: 0;
            width: 100%; height: 100%;
            background: var(--bg);
            color: white;
            font-family: 'Inter', system-ui, sans-serif;
            overflow: hidden;
        }

        #content-frame {
            width: 100%; height: 100%;
            border: none;
            transition: opacity 0.5s ease, filter 0.5s ease;
        }

        /* Modern Glass Modal */
        #update-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(12px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.4s ease;
        }

        #update-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .modal {
            background: var(--panel);
            padding: 2rem;
            border-radius: 24px;
            border: 1px solid rgba(255,255,255,0.1);
            text-align: center;
            max-width: 400px;
            box-shadow: 0 0 40px rgba(0, 242, 255, 0.15);
        }

        .spinner {
            width: 40px; height: 40px;
            border: 3px solid rgba(255,255,255,0.1);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1.5rem;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        h2 { margin: 0 0 0.5rem; font-weight: 600; letter-spacing: -0.5px; }
        p { color: #888; font-size: 0.9rem; margin: 0; }

        .hidden { display: none; }
    </style>
</head>
<body class="loading">

    <div id="update-overlay">
        <div class="modal">
            <div class="spinner"></div>
            <h2 id="status-title">Daily Syncing for new update.</h2>
            <p id="status-desc">Fetching the latest version from GitHub...</p>
        </div>
    </div>

    <iframe id="content-frame"></iframe>

<script>
    const frame = document.getElementById('content-frame');
    const overlay = document.getElementById('update-overlay');
    const title = document.getElementById('status-title');
    
    const GITHUB_URL = "https://raw.githubusercontent.com/code-andrewy/jumpman64beta/refs/heads/main/wyd.html";
    const ONE_DAY = 24 * 60 * 60 * 1000; // 24 hours in ms

    async function init() {
        const lastUpdate = localStorage.getItem('last_sync_time');
        const savedHtml = localStorage.getItem('cached_html');
        const now = Date.now();

        // Check if we need to update (No cache OR older than 24 hours)
        if (!savedHtml || !lastUpdate || (now - lastUpdate > ONE_DAY)) {
            await performUpdate();
        } else {
            console.log("Loading from local cache (Updated less than 24h ago)");
            loadIntoFrame(savedHtml);
        }
    }

    async function performUpdate() {
        overlay.classList.add('visible');
        try {
            const response = await fetch(`${GITHUB_URL}?t=${Date.now()}`);
            if (!response.ok) throw new Error();
            
            const html = await response.text();
            
            // Save to local storage for the next 24 hours
            localStorage.setItem('cached_html', html);
            localStorage.setItem('last_sync_time', Date.now().toString());

            loadIntoFrame(html);
            
            // Success feedback
            setTimeout(() => {
                overlay.classList.remove('visible');
            }, 1000);

        } catch (err) {
            title.innerText = "Sync Failed";
            document.getElementById('status-desc').innerText = "Check connection. Using last known version.";
            setTimeout(() => {
                if (localStorage.getItem('cached_html')) {
                    loadIntoFrame(localStorage.getItem('cached_html'));
                }
                overlay.classList.remove('visible');
            }, 2000);
        }
    }

    let currentBlobUrl = null;
    function loadIntoFrame(htmlContent) {
        if (currentBlobUrl) URL.revokeObjectURL(currentBlobUrl);
        
        const blob = new Blob([htmlContent], { type: 'text/html' });
        currentBlobUrl = URL.createObjectURL(blob);
        frame.src = currentBlobUrl;
    }

    // Refresh only when user switches back AND a day has passed
    document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible') {
            const lastUpdate = localStorage.getItem('last_sync_time');
            if (Date.now() - lastUpdate > ONE_DAY) {
                performUpdate();
            }
        }
    });

    // Ctrl+J Force Manual Refresh
    document.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'j') {
            e.preventDefault();
            performUpdate();
        }
    });

    init();
</script>
</body>
</html>
