<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Error...</title>
    <style>
        body { background: #050505; color: #00f2ff; font-family: sans-serif; display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0; }
        .loader { border: 2px solid rgba(0,242,255,0.1); border-top: 2px solid #00f2ff; border-radius: 50%; width: 24px; height: 24px; animation: spin 0.8s linear infinite; margin-right: 12px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="loader"></div>
    <div id="msg">Initializing Secure Blob...</div>

<script>
    const GITHUB_URL = "https://raw.githubusercontent.com/code-andrewy/jumpman64beta/refs/heads/main/brooooooooo.html";
    const DAY_MS = 86400000;

    async function launch() {
        // 1. Check if we are already inside a blob
        if (window.location.protocol === 'blob:') {
            console.log("Running in secure blob environment.");
            return; 
        }

        const lastSync = localStorage.getItem('p_sync');
        const cached = localStorage.getItem('p_cache');
        const now = Date.now();

        let htmlToLoad = cached;

        // 2. Decide if we need a fresh fetch (24h rule)
        if (!cached || !lastSync || (now - lastSync > DAY_MS)) {
            document.getElementById('msg').innerText = "Syncing with GitHub...";
            try {
                const res = await fetch(`${GITHUB_URL}?t=${now}`);
                htmlToLoad = await res.text();
                localStorage.setItem('p_cache', htmlToLoad);
                localStorage.setItem('p_sync', now);
            } catch (e) {
                if (!htmlToLoad) {
                    document.getElementById('msg').innerText = "Connection Error.";
                    return;
                }
            }
        }

        // 3. Create the Blob and Redirect the URL
        // We inject a script into the blob to handle the "Tab Switch" logic 
        // since the blob becomes the new "Main Page".
        const blobScript = `
            <script>
                document.addEventListener('visibilitychange', () => {
                    if (document.visibilityState === 'visible') {
                        // Check if 24h passed, if so, reload the master redirector
                        const last = localStorage.getItem('p_sync');
                        if (Date.now() - last > ${DAY_MS}) {
                            window.location.href = window.location.origin + window.location.pathname;
                        }
                    }
                });
                // Shortcut Ctrl+J to force update
                document.addEventListener('keydown', (e) => {
                    if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'j') {
                        window.location.href = window.location.origin + window.location.pathname;
                    }
                });
            <\/script>
        `;

        const blob = new Blob([htmlToLoad + blobScript], { type: 'text/html' });
        const blobUrl = URL.createObjectURL(blob);

        // 4. Transform the URL bar to blob:
        window.location.replace(blobUrl);
    }

    launch();
</script>
</body>
</html>
